# Makefile pour tester le Helm chart localement
# Usage: make -f Makefile.helm <target>

CHART_DIR = charts/klask
RELEASE_NAME = klask-test
NAMESPACE = default

.PHONY: help lint template dry-run install uninstall package test-all

help: ## Affiche cette aide
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

lint: ## Valide la syntaxe du chart
	@echo "ğŸ” Validation de la syntaxe..."
	helm lint $(CHART_DIR)

dependencies: ## Met Ã  jour les dÃ©pendances
	@echo "ğŸ“¦ Mise Ã  jour des dÃ©pendances..."
	helm repo add bitnami https://charts.bitnami.com/bitnami
	helm repo update
	cd $(CHART_DIR) && helm dependency update

template: dependencies ## GÃ©nÃ¨re les templates sans installation
	@echo "ğŸ“‹ GÃ©nÃ©ration des templates..."
	helm template $(RELEASE_NAME) $(CHART_DIR) --debug

dry-run: dependencies ## Teste l'installation sans dÃ©ployer
	@echo "ğŸ§ª Test d'installation (dry-run)..."
	helm install $(RELEASE_NAME) $(CHART_DIR) --dry-run --debug

install: dependencies ## Installe le chart sur le cluster
	@echo "ğŸš€ Installation du chart..."
	helm install $(RELEASE_NAME) $(CHART_DIR) --wait

upgrade: dependencies ## Met Ã  jour le chart installÃ©
	@echo "â¬†ï¸  Mise Ã  jour du chart..."
	helm upgrade $(RELEASE_NAME) $(CHART_DIR) --wait

uninstall: ## DÃ©sinstalle le chart
	@echo "ğŸ—‘ï¸  DÃ©sinstallation du chart..."
	helm uninstall $(RELEASE_NAME)

status: ## Affiche le statut du dÃ©ploiement
	@echo "ğŸ“Š Statut du dÃ©ploiement..."
	helm status $(RELEASE_NAME)
	kubectl get pods -l "app.kubernetes.io/instance=$(RELEASE_NAME)"

logs: ## Affiche les logs des composants
	@echo "ğŸ“œ Logs backend:"
	kubectl logs -l "app.kubernetes.io/instance=$(RELEASE_NAME),app.kubernetes.io/component=backend" --tail=20
	@echo "ğŸ“œ Logs frontend:"
	kubectl logs -l "app.kubernetes.io/instance=$(RELEASE_NAME),app.kubernetes.io/component=frontend" --tail=20

package: dependencies ## Package le chart en archive
	@echo "ğŸ“¦ Packaging du chart..."
	cd charts && helm package klask

test-values: ## Teste avec diffÃ©rentes configurations
	@echo "ğŸ§ª Test avec ingress activÃ©..."
	helm template test-ingress $(CHART_DIR) --set ingress.enabled=true --dry-run > /dev/null
	@echo "âœ… Ingress OK"
	
	@echo "ğŸ§ª Test avec PostgreSQL externe..."
	helm template test-external-db $(CHART_DIR) --set postgresql.enabled=false --dry-run > /dev/null
	@echo "âœ… PostgreSQL externe OK"
	
	@echo "ğŸ§ª Test avec ressources personnalisÃ©es..."
	helm template test-resources $(CHART_DIR) \
		--set backend.resources.requests.cpu=200m \
		--set frontend.resources.limits.memory=1Gi \
		--dry-run > /dev/null
	@echo "âœ… Ressources personnalisÃ©es OK"

test-all: lint template dry-run test-values package ## Lance tous les tests
	@echo "ğŸ‰ Tous les tests sont passÃ©s !"

# Tests avec clusters locaux
kind-install: ## Installe sur cluster kind local
	@echo "ğŸ³ Installation sur kind..."
	helm install $(RELEASE_NAME) $(CHART_DIR) --wait --timeout=10m

minikube-install: ## Installe sur minikube local
	@echo "â˜¸ï¸  Installation sur minikube..."
	helm install $(RELEASE_NAME) $(CHART_DIR) --wait --timeout=10m
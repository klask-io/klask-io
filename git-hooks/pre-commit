#!/bin/bash

# Git pre-commit hook to format Rust code with cargo fmt
# This hook will automatically format Rust code before each commit

echo "ğŸ”§ Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f "klask-rs/Cargo.toml" ]; then
    echo "âš ï¸  Warning: klask-rs/Cargo.toml not found, skipping cargo fmt"
    exit 0
fi

# Store the current directory
ORIGINAL_DIR=$(pwd)

# Change to the Rust directory
cd klask-rs

echo "ğŸ“ Checking Rust code formatting..."

# Check if there are any staged Rust files
if ! git diff --cached --name-only | grep -E '\.(rs)$' >/dev/null; then
    echo "â„¹ï¸  No Rust files staged for commit, skipping formatting"
    cd "$ORIGINAL_DIR"
    exit 0
fi

# Run cargo fmt check
if ! cargo fmt --all -- --check >/dev/null 2>&1; then
    echo "ğŸ”¨ Code formatting issues detected. Running cargo fmt..."

    # Format the code
    if cargo fmt --all; then
        echo "âœ… Code formatted successfully with cargo fmt"

        # Add only the modified staged files back to the commit
        echo "ğŸ“¤ Adding formatted files to staging area..."

        # Get the list of staged Rust files and re-add them
        cd "$ORIGINAL_DIR"
        git diff --cached --name-only | grep -E '\.(rs)$' | while read file; do
            if [ -f "$file" ]; then
                git add "$file"
                echo "   âœ“ Added $file"
            fi
        done

        echo "âœ… Formatted files added to commit"
    else
        echo "âŒ cargo fmt failed"
        cd "$ORIGINAL_DIR"
        exit 1
    fi
else
    echo "âœ… Code is already properly formatted"
fi

cd "$ORIGINAL_DIR"
echo "ğŸ‰ Pre-commit hook completed successfully"
exit 0